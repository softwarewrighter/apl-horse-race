<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APL Horse Race Simulator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            background: #f5f5f5;
            font-family: 'Courier New', Courier, monospace;
            min-height: 100vh;
            padding: 20px;
            text-transform: uppercase;
        }
        .paper-container {
            max-width: 700px;
            margin: 0 auto;
            background: #fff;
            border: 1px solid #ccc;
            box-shadow: 2px 2px 10px rgba(0,0,0,0.1);
        }
        .header {
            background: #eee;
            padding: 10px 20px;
            border-bottom: 1px solid #ccc;
            font-size: 0.85em;
            color: #666;
        }
        .greenbar {
            min-height: 500px;
            max-height: 600px;
            overflow-y: auto;
            background: repeating-linear-gradient(
                to bottom,
                #fff 0px,
                #fff 20px,
                #e8f5e9 20px,
                #e8f5e9 40px
            );
            padding: 10px 20px;
            line-height: 20px;
            font-size: 14px;
            color: #000;
        }
        #output {
            white-space: pre;
            min-height: 400px;
        }
        .prompt-area {
            background: #fafafa;
            padding: 10px 20px;
            border-top: 1px solid #ccc;
            display: flex;
            align-items: center;
        }
        .prompt {
            color: #000;
            margin-right: 8px;
            font-weight: bold;
        }
        #input {
            background: transparent;
            border: none;
            color: #000;
            font-family: inherit;
            font-size: inherit;
            outline: none;
            flex: 1;
            text-transform: uppercase;
        }
        .links {
            padding: 15px 20px;
            text-align: center;
            font-size: 0.85em;
            background: #fafafa;
            border-top: 1px solid #eee;
        }
        .links a {
            color: #0066cc;
            text-decoration: none;
            margin: 0 10px;
        }
        .links a:hover {
            text-decoration: underline;
        }
        .cursor {
            display: inline-block;
            width: 8px;
            height: 14px;
            background: #000;
            animation: blink 1s step-end infinite;
            vertical-align: text-bottom;
        }
        @keyframes blink {
            50% { opacity: 0; }
        }
    </style>
</head>
<body>
    <div class="paper-container">
        <div class="header">
            GNU APL 1.8 &mdash; 15 CPS TELETYPE SIMULATION
        </div>
        <div class="greenbar">
            <div id="output"></div><span class="cursor" id="cursor"></span>
        </div>
        <div class="prompt-area">
            <span class="prompt">)</span>
            <input type="text" id="input" autofocus autocomplete="off" placeholder="type RACE">
        </div>
        <div class="links">
            <a href="https://github.com/sw-comp-history/apl-horse-race">Source Code</a>
            <a href="https://github.com/sw-comp-history/apl-horse-race/blob/main/docs/race-apl-explained.md">Documentation</a>
        </div>
    </div>

    <script>
        const horses = ['LUCKY', 'THUNDER', 'SHADOW', 'COMET', 'BLAZE'];
        const finishLine = 17;

        // 15 CPS = ~67ms per char, with noise
        const baseCharDelay = 67;
        const noiseChance = 0.15;
        const noisePause = 100;

        let running = false;
        const output = document.getElementById('output');
        const cursor = document.getElementById('cursor');
        const input = document.getElementById('input');
        const greenbar = document.querySelector('.greenbar');

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function getCharDelay() {
            // Base delay with slight randomness
            let delay = baseCharDelay + Math.random() * 30 - 15;
            // Occasional line noise pause
            if (Math.random() < noiseChance) {
                delay += noisePause + Math.random() * 150;
            }
            return delay;
        }

        async function typeChar(char) {
            output.textContent += char;
            greenbar.scrollTop = greenbar.scrollHeight;
            await sleep(getCharDelay());
        }

        async function typeLine(text) {
            for (const char of text) {
                await typeChar(char);
            }
            await typeChar('\n');
        }

        async function typeText(text) {
            for (const char of text) {
                await typeChar(char);
            }
        }

        async function runRace() {
            if (running) return;
            running = true;
            input.disabled = true;
            cursor.style.display = 'none';

            // Initialize positions
            const positions = {};
            horses.forEach(h => positions[h] = 0);

            // Header
            await typeLine('');
            await typeLine('==========================================');
            await typeLine('           THE RACE IS ON!');
            await typeLine('==========================================');
            await typeLine('');

            let round = 1;
            let winner = null;

            while (!winner) {
                await typeLine('--- ROUND ' + round + ' ---');

                // Move each horse
                for (const horse of horses) {
                    const move = Math.floor(Math.random() * 3) + 1;
                    positions[horse] += move;

                    const track = String.fromCharCode(0x2593).repeat(positions[horse]) + '<';
                    const paddedName = horse.padEnd(7);

                    await typeText(paddedName + ' |' + track);
                    await typeChar('\n');

                    if (positions[horse] >= finishLine && !winner) {
                        winner = horse;
                    }
                }

                await typeLine('');
                round++;
            }

            // Winner announcement
            await typeLine('==========================================');
            await typeLine('WINNER: ' + winner + ' !');
            await typeLine('==========================================');
            await typeLine('');
            await typeLine('Type RACE to run again');
            await typeLine('');

            running = false;
            input.disabled = false;
            input.value = '';
            input.focus();
            cursor.style.display = 'inline-block';
        }

        async function init() {
            await typeLine('APL HORSE RACE SIMULATOR');
            await typeLine('Recreation of APL\\360 horse race (1970s)');
            await typeLine('');
            await typeLine('Type RACE to start the simulation');
            await typeLine('');
            cursor.style.display = 'inline-block';
        }

        input.addEventListener('keydown', async function(e) {
            if (e.key === 'Enter' && !running) {
                const cmd = input.value.trim().toUpperCase();
                cursor.style.display = 'none';
                await typeText(')' + cmd);
                await typeChar('\n');

                if (cmd === 'RACE') {
                    input.value = '';
                    runRace();
                } else if (cmd === 'HELP') {
                    await typeLine('Commands: RACE - start the horse race');
                    await typeLine('');
                    input.value = '';
                    cursor.style.display = 'inline-block';
                } else if (cmd === 'CLEAR') {
                    output.textContent = '';
                    input.value = '';
                    init();
                } else if (cmd !== '') {
                    await typeLine('SYNTAX ERROR');
                    await typeLine('');
                    input.value = '';
                    cursor.style.display = 'inline-block';
                } else {
                    input.value = '';
                    cursor.style.display = 'inline-block';
                }
            }
        });

        init();
    </script>
</body>
</html>
